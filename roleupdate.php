<?php
$access_token = "1000.9b0323409b62e2521d724cd45afdfd89.36b41eb4fba656b6af0b27e26fbc8d34";
$movies = array(
array("user_Id"=>"1699841000536354005","email_id"=>"dhwani.joshi@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"C159022","first_Name"=>"Dhwani TarunBhai","reporting_id"=>"1699841000130042781","last_name"=>"Joshi","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000536337004","email_id"=>"ganesh.kadam@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"C159030","first_Name"=>"Ganesh Balu","reporting_id"=>"1699841000130042781","last_name"=>"Kadam","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000536345005","email_id"=>"faisal.mistri@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"C159027","first_Name"=>"Faisal Farukbhai","reporting_id"=>"1699841000130042781","last_name"=>"Mistri","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000536344009","email_id"=>"mohammedmohsin.baringwala@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"C159023","first_Name"=>"Mohammedmohsin","reporting_id"=>"1699841000130042781","last_name"=>"Baringwala","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000387573019","email_id"=>"a202597@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"A202597","first_Name"=>"Shaik","reporting_id"=>"1699841000130042781","last_name"=>"Baba","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000392399017","email_id"=>"mahmadafjad.vora@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157799","first_Name"=>"mahmadafjad","reporting_id"=>"1699841000329036095","last_name"=>"vora","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000382815014","email_id"=>"dharmesh.kachhadiya@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157552","first_Name"=>"dharmesh","reporting_id"=>"1699841000329036095","last_name"=>"kachhadiya","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000381009429","email_id"=>"nirav.patel@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157215","first_Name"=>"Nirav","reporting_id"=>"1699841000329036095","last_name"=>"Patel","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000364435599","email_id"=>"gaurang.pithava@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157208","first_Name"=>"gaurang","reporting_id"=>"1699841000329036095","last_name"=>"pithava","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000364062744","email_id"=>"vipul.trivedi@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157207","first_Name"=>"vipul","reporting_id"=>"1699841000329036095","last_name"=>"trivedi","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000364242494","email_id"=>"vakar.amreliya@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157272","first_Name"=>"vakar","reporting_id"=>"1699841000329036095","last_name"=>"amreliya","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000364221022","email_id"=>"a202558@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"a202558","first_Name"=>"Rushabh","reporting_id"=>"1699841000329036095","last_name"=>"Patel","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000363945502","email_id"=>"a202555@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"A202555","first_Name"=>"jalpa","reporting_id"=>"1699841000329036095","last_name"=>"kukvav","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000360108004","email_id"=>"bharatsinh.chavda@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157229","first_Name"=>"Bharatsinh","reporting_id"=>"1699841000329036095","last_name"=>"Chavda","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000360040258","email_id"=>"pravin.dafda@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C157227","first_Name"=>"Pravin","reporting_id"=>"1699841000329036095","last_name"=>"Dafda","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000360003108","email_id"=>"a202563@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"A202563","first_Name"=>"Anshul","reporting_id"=>"1699841000329036095","last_name"=>"Chauhan","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000359947260","email_id"=>"a202553@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"A202553","first_Name"=>"Raj","reporting_id"=>"1699841000329036095","last_name"=>"Jaskar","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000299662769","email_id"=>"varun.arora@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C156486","first_Name"=>"Varun","reporting_id"=>"1699841000329036095","last_name"=>"Arora","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000300479790","email_id"=>"vishal.jotangiya@5paisa.com","role_id"=>"1699841000401012259","Emp_Code"=>"C156480","first_Name"=>"Vishal","reporting_id"=>"1699841000329036095","last_name"=>"Jotangiya","State"=>"Mutual Funds"));
$userd_id_param="user_Id";
$role_id_param="role_id";
$Emp_Code_param="Emp_Code";
$reporting_id_param="reporting_id";
$last_name_param="last_name";
$state_param="state";
foreach ( $movies as $movie ) {
  foreach ( $movie as $key => $value ) {
    error_log ("<dt>$key</dt><dd>$value</dd>");
    if(strpos($key, $userd_id_param)!== false){
      $recordId = $value;
    }
    if(strpos($key, $role_id_param)!== false){
      $role_id = '"'.$value.'"';
    }
    if(strpos($key, $Emp_Code_param)!== false){
      $Emp_Code = '"'.$value.'"';
    }
    if(strpos($key, $state_param)!== false){
      $state = '"'.$value.'"';
    }
    if(strpos($key, $last_name_param)!== false){
      $last_name = '"'.$value.'"';
    }
    if(strpos($key, $reporting_id_param)!== false){
      $reporting_id = '"'.$value.'"';
    }
  }
  $url = "https://www.zohoapis.com/crm/v2/users/$recordId";
  error_log($url);
  $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
  $headers = array("Authorization: $accesstokenparam");
  $content_type = "application/json";
  //$headers->Content-type = $content_type;
  //$headers->Authorization = $accesstokenparam;
  error_log(json_encode($headers));
  $ch = curl_init();
  $param1 = '{"users":[{"Reporting_To":{"id":';
  //$param1 = '{"users":[{"role":';
  //$param10 = ',"role_id":';
  $param9 = ',"reporting_to_id":';
  $reportingid = $reporting_id;
  //$param2 = ', "Emp_Code":';
  //$param3 = ', "state":';
  $param4 = '}}]}'; 
  //$param4 = '}]}'; 
  /*
  {
    "users": [
       {
"role":"${ROLE_ID}"
        }
    ]
}*/
  
  /*
  {
     "users":[
         {
            "Reporting_To":
            {
                "id":"${REPORTING_TO_ID}"
            }
         }
     ]
}*/
  
  $json = $param1.$reportingid.$param4;
  //$json = $param1.$role_id.$param4;
  //$json = $param1.$last_name.$param10.$reportingid.$param2.$Emp_Code.$param3.$state.$param4;
  //$json = $param1.$last_name.$param2.$Emp_Code.$param3.$state.$param4;
  error_log($json);
  $result = json_decode ($json);
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
  curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
  $st=curl_exec($ch);
  error_log("first response");
  error_log($st);
  $Code = "code";
  $Message = "message";
  $AlternatePhoneNumber = "invalid";
  $AlternatePhoneNumber2 = "FAILURE";
  $arr = (json_decode($st, true));
  foreach ( $arr as $key=>$val ){
    if(strpos($key, $Message)!== false){
      if(strpos($val, $AlternatePhoneNumber)!== false){
        $REFRESH_TOKEN_ID = '1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec';
        $CLIENT_ID = '1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U';
        $CLIENT_SECRET = '034bc2464c3093c42b6605b6297af733557ffcc3cb';
        $accesstokenurl = "https://accounts.zoho.com/oauth/v2/token?refresh_token=1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec&client_id=1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U&client_secret=034bc2464c3093c42b6605b6297af733557ffcc3cb&grant_type=refresh_token";
        //$grant_type = 'refresh_token';
        //error_log($accesstokenurl);
        $tokench = curl_init();
        $myObj->grant_type = $grant_type;
        $myObj->refresh_token = $REFRESH_TOKEN_ID;
        $myObj->client_id = $CLIENT_ID;
        $myObj->client_secret=$CLIENT_SECRET;
        $tokenjson = json_encode($myObj);
        curl_setopt($tokench, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($tokench, CURLOPT_URL, $accesstokenurl);
        curl_setopt($tokench, CURLOPT_RETURNTRANSFER, 1);  
        $tokenst=curl_exec($tokench);
        error_log("token response");
        error_log($tokenst);
        $access_token_param="access_token";
        $arr = (json_decode($tokenst, true));
        foreach ( $arr as $key=>$val ){
          if(strpos($key, $access_token_param)!== false){
            error_log($val);
            $access_token=$val;
            //$url = "https://www.zohoapis.com/crm/v2/users/{$recordId}";
            $url = "https://crm.zoho.com/crm/v2/Users";
            error_log($url);
            $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
            $headers = array("Authorization: $accesstokenparam");
            $content_type = "application/json";
            error_log(json_encode($headers));
            $ch = curl_init();
            $result = json_decode ($json);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
            curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
            $st=curl_exec($ch);
            error_log("first response");
            error_log($st);          
          }
        }
      }
    }
  }
}
?>
