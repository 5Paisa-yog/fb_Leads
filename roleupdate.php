<?php
$access_token = "1000.b001ede62e33a522e0d26c061fff21db.c931f830937d2fbfb5de0543feaac8cb";
$movies = array(
array("user_Id"=>"1699841000159746758","email_id"=>"imran.shaikh@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C152978","first_Name"=>"Imran Shaikh","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000180516120","email_id"=>"jahoor.ahemed@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C153433","first_Name"=>"Jahoor Usman Ahemed","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000106622430","email_id"=>"bharathi.kuppusamy@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C151383","first_Name"=>"Bharathi Kuppusamy K","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000156364151","email_id"=>"ganesh.veluru@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C152883","first_Name"=>"Ganesh Veluru","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000275389826","email_id"=>"A202429@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A202429","first_Name"=>"Karisma S","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000237303864","email_id"=>"A202347@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A202347","first_Name"=>"Janaki C","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000239775813","email_id"=>"A202348@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A202348","first_Name"=>"Chiranjeevi A","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000109127822","email_id"=>"a201973@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A201973","first_Name"=>"Gunashekaran Murugesh M","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000109300207","email_id"=>"a201971@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A201971","first_Name"=>"Jaffar Sadiq","reporting_id"=>"1699841000094049742","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000192702718","email_id"=>"vandana.s@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C153784","first_Name"=>"Vandana S","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000180521001","email_id"=>"sukanya.m@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C153441","first_Name"=>"Sukanya Gopalacharya M","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000156336301","email_id"=>"Manjula.r@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C152893","first_Name"=>"Manjula R","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000355525231","email_id"=>"a202514@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"A202514","first_Name"=>"ArshadÂ Iyoob","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000160330563","email_id"=>"meena.p@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C152981","first_Name"=>"Meena P","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000368812250","email_id"=>"madhura.m@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C157407","first_Name"=>"Madhura M","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425635048","email_id"=>"bhavya.v@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158076","first_Name"=>"Bhavya Vasu V","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000423693419","email_id"=>"karishma.limbu@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158136","first_Name"=>"Karishma Lembahadur Limbu","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425006772","email_id"=>"taniya.s@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158112","first_Name"=>"Taniya Heraz S","reporting_id"=>"1699841000095390961","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425348535","email_id"=>"mohammed.tanveer@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158082","first_Name"=>"Mohammed Nuaman Tanveer","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000102323004","email_id"=>"syed.saif@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C151351","first_Name"=>"Saif Syed","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000117659905","email_id"=>"ebin.rony@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C151440","first_Name"=>"Ebin Rony","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425040934","email_id"=>"priyanka.c@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158089","first_Name"=>"Priyanka Jayaramulu C","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425498253","email_id"=>"mohammed.ilyas@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158091","first_Name"=>"Mohammed Ilyas","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425379195","email_id"=>"afshan.firdose@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158096","first_Name"=>"Afshan Safeerahamed Firdose","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425523225","email_id"=>"fahad.ansari@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158097","first_Name"=>"Fahad Fazlullah Ansari","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425348232","email_id"=>"syed.hussaini@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158111","first_Name"=>"Syed Yaseen Hussaini","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425417084","email_id"=>"ranjeeth.n@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158115","first_Name"=>"Ranjeeth Kumar N","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000425090561","email_id"=>"abhishek.n@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158116","first_Name"=>"Abhishek M N","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000423693710","email_id"=>"deepak.p@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158118","first_Name"=>"Deepak P","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000456607202","email_id"=>"prasenjit.das@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158183","first_Name"=>"Prasenjit Prabirkumar Das","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000309833849","email_id"=>"mohammed.shahil@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C156588","first_Name"=>"Mohammed Shahil K","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"),
array("user_Id"=>"1699841000456449929","email_id"=>"vimal.koshy@5paisa.com","role_id"=>"1699841000342631703","Emp_Code"=>"C158184","first_Name"=>"Vimal Varghese Koshy","reporting_id"=>"1699841000425293597","last_name"=>"Bangalore Sales","State"=>"Bangalore"));
$userd_id_param="user_Id";
$role_id_param="role_id";
$Emp_Code_param="Emp_Code";
$reporting_id_param="reporting_id";
$last_name_param="last_name";
$state_param="state";
foreach ( $movies as $movie ) {
  foreach ( $movie as $key => $value ) {
    error_log ("<dt>$key</dt><dd>$value</dd>");
    if(strpos($key, $userd_id_param)!== false){
      $recordId = $value;
    }
    if(strpos($key, $role_id_param)!== false){
      $role_id = '"'.$value.'"';
    }
    if(strpos($key, $Emp_Code_param)!== false){
      $Emp_Code = '"'.$value.'"';
    }
    if(strpos($key, $state_param)!== false){
      $state = '"'.$value.'"';
    }
    if(strpos($key, $last_name_param)!== false){
      $last_name = '"'.$value.'"';
    }
    if(strpos($key, $reporting_id_param)!== false){
      $reporting_id = '"'.$value.'"';
    }
  }
  $url = "https://www.zohoapis.com/crm/v2/users/$recordId";
  error_log($url);
  $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
  $headers = array("Authorization: $accesstokenparam");
  $content_type = "application/json";
  //$headers->Content-type = $content_type;
  //$headers->Authorization = $accesstokenparam;
  error_log(json_encode($headers));
  $ch = curl_init();
  $param1 = '{"users":[{"Reporting_To":{"id":';
  $param10 = ',"role_id":';
  $param9 = ',"reporting_to_id":';
  $reportingid = $reporting_id;
  //$param2 = ', "Emp_Code":';
  //$param3 = ', "state":';
  $param4 = '}}]}'; 
  /*
  {
    "users": [
       {
"role":"${ROLE_ID}"
        }
    ]
}*/
  
  /*
  {
     "users":[
         {
            "Reporting_To":
            {
                "id":"${REPORTING_TO_ID}"
            }
         }
     ]
}*/
  
  $json = $param1.$reportingid.$param4;
  //$json = $param1.$last_name.$param10.$reportingid.$param2.$Emp_Code.$param3.$state.$param4;
  //$json = $param1.$last_name.$param2.$Emp_Code.$param3.$state.$param4;
  error_log($json);
  $result = json_decode ($json);
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
  curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
  $st=curl_exec($ch);
  error_log("first response");
  error_log($st);
  $Code = "code";
  $Message = "message";
  $AlternatePhoneNumber = "invalid";
  $AlternatePhoneNumber2 = "FAILURE";
  $arr = (json_decode($st, true));
  foreach ( $arr as $key=>$val ){
    if(strpos($key, $Message)!== false){
      if(strpos($val, $AlternatePhoneNumber)!== false){
        $REFRESH_TOKEN_ID = '1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec';
        $CLIENT_ID = '1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U';
        $CLIENT_SECRET = '034bc2464c3093c42b6605b6297af733557ffcc3cb';
        $accesstokenurl = "https://accounts.zoho.com/oauth/v2/token?refresh_token=1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec&client_id=1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U&client_secret=034bc2464c3093c42b6605b6297af733557ffcc3cb&grant_type=refresh_token";
        //$grant_type = 'refresh_token';
        //error_log($accesstokenurl);
        $tokench = curl_init();
        $myObj->grant_type = $grant_type;
        $myObj->refresh_token = $REFRESH_TOKEN_ID;
        $myObj->client_id = $CLIENT_ID;
        $myObj->client_secret=$CLIENT_SECRET;
        $tokenjson = json_encode($myObj);
        curl_setopt($tokench, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($tokench, CURLOPT_URL, $accesstokenurl);
        curl_setopt($tokench, CURLOPT_RETURNTRANSFER, 1);  
        $tokenst=curl_exec($tokench);
        error_log("token response");
        error_log($tokenst);
        $access_token_param="access_token";
        $arr = (json_decode($tokenst, true));
        foreach ( $arr as $key=>$val ){
          if(strpos($key, $access_token_param)!== false){
            error_log($val);
            $access_token=$val;
            //$url = "https://www.zohoapis.com/crm/v2/users/{$recordId}";
            $url = "https://crm.zoho.com/crm/v2/Users";
            error_log($url);
            $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
            $headers = array("Authorization: $accesstokenparam");
            $content_type = "application/json";
            error_log(json_encode($headers));
            $ch = curl_init();
            $result = json_decode ($json);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
            curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
            $st=curl_exec($ch);
            error_log("first response");
            error_log($st);          
          }
        }
      }
    }
  }
}
?>
