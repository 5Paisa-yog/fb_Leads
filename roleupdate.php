<?php
$access_token = "1000.9b0323409b62e2521d724cd45afdfd89.36b41eb4fba656b6af0b27e26fbc8d34";
$movies = array(
array("user_Id"=>"1699841000536354005","email_id"=>"dhwani.joshi@5paisa.com","role_id"=>"1699841000401012289","Emp_Code"=>"C159022","first_Name"=>"Dhwani TarunBhai","reporting_id"=>"1699841000130042781","last_name"=>"Joshi","State"=>"Mutual Funds"),
array("user_Id"=>"1699841000548117102","email_id"=>"shilpa.wanjari@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C158891","first_Name"=>"Shilpa","reporting_id"=>"1699841000050396825","last_name"=>"wanjari","State"=>"Mumbai"),
array("user_Id"=>"1699841000546464936","email_id"=>"tripti.singh@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C158894","first_Name"=>"Tripti","reporting_id"=>"1699841000050396825","last_name"=>"singh","State"=>"Mumbai"),
array("user_Id"=>"1699841000456140801","email_id"=>"a202659@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202659","first_Name"=>"Mohammed","reporting_id"=>"1699841000225646124","last_name"=>"NuamanÂ ","State"=>"Mumbai"),
array("user_Id"=>"1699841000436735638","email_id"=>"santosh.yadav@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"","first_Name"=>"santosh","reporting_id"=>"1699841000050396825","last_name"=>"yadav","State"=>"Mumbai"),
array("user_Id"=>"1699841000424072985","email_id"=>"sudharshan.j@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C158094","first_Name"=>"sudharshan","reporting_id"=>"1699841000225646124","last_name"=>"j","State"=>"Mumbai"),
array("user_Id"=>"1699841000425348113","email_id"=>"brijesh.mishra@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C158130","first_Name"=>"brijesh","reporting_id"=>"1699841000050396825","last_name"=>"mishra","State"=>"Mumbai"),
array("user_Id"=>"1699841000423916709","email_id"=>"anand.patil@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C158053","first_Name"=>"anand","reporting_id"=>"1699841000050396825","last_name"=>"patil","State"=>"Mumbai"),
array("user_Id"=>"1699841000411910804","email_id"=>"a202499@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A202499","first_Name"=>"a202499","reporting_id"=>"1699841000050396825","last_name"=>"Pithadiya","State"=>"Mumbai"),
array("user_Id"=>"1699841000407104717","email_id"=>"rajshekhar.bandyopadhyay@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C157825","first_Name"=>"rajshekhar","reporting_id"=>"1699841000050396825","last_name"=>"bandyopadhyay","State"=>"Mumbai"),
array("user_Id"=>"1699841000407474114","email_id"=>"dibakar.naskar@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C157817","first_Name"=>"dibakar","reporting_id"=>"1699841000050396825","last_name"=>"naskar","State"=>"Mumbai"),
array("user_Id"=>"1699841000392622118","email_id"=>"a202603@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A202603","first_Name"=>"Anip","reporting_id"=>"1699841000050396825","last_name"=>"jha","State"=>"Mumbai"),
array("user_Id"=>"1699841000392547330","email_id"=>"priyanka.kamble@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C157402","first_Name"=>"priyanka","reporting_id"=>"1699841000050396825","last_name"=>"kamble","State"=>"Mumbai"),
array("user_Id"=>"1699841000369519800","email_id"=>"a202542@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202542","first_Name"=>"Vijay","reporting_id"=>"1699841000050396825","last_name"=>"Dewde","State"=>"Mumbai"),
array("user_Id"=>"1699841000369770369","email_id"=>"raju.pasi@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C157180","first_Name"=>"raju","reporting_id"=>"1699841000050396825","last_name"=>"pasi","State"=>"Mumbai"),
array("user_Id"=>"1699841000369370059","email_id"=>"incidentmanagement@iifl.com","role_id"=>"1699841000342631699","Emp_Code"=>"","first_Name"=>"Incident ","reporting_id"=>"1699841000050396825","last_name"=>"Management","State"=>"Mumbai"),
array("user_Id"=>"1699841000311564997","email_id"=>"sumedha.shetye@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"","first_Name"=>"Sumedha","reporting_id"=>"1699841000050396825","last_name"=>"Shetye","State"=>"Mumbai"),
array("user_Id"=>"1699841000299155719","email_id"=>"amit.singh@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C156458","first_Name"=>"Amit","reporting_id"=>"1699841000050396825","last_name"=>"Singh","State"=>"Mumbai"),
array("user_Id"=>"1699841000299011924","email_id"=>"a202494@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A202494","first_Name"=>"Parag","reporting_id"=>"1699841000050396825","last_name"=>"Yeshwante","State"=>"Mumbai"),
array("user_Id"=>"1699841000294037847","email_id"=>"a202489@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202489","first_Name"=>"Pratiksha","reporting_id"=>"1699841000050396825","last_name"=>"Kamble","State"=>"Mumbai"),
array("user_Id"=>"1699841000287170849","email_id"=>"naresh.mudrakola@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C156086","first_Name"=>"Naresh","reporting_id"=>"1699841000050396825","last_name"=>"Mudrakola","State"=>"Mumbai"),
array("user_Id"=>"1699841000272352390","email_id"=>"suraj.sharma@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C155871","first_Name"=>"Suraj","reporting_id"=>"1699841000050396825","last_name"=>"Sharma","State"=>"Mumbai"),
array("user_Id"=>"1699841000272523683","email_id"=>"a202422@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202422","first_Name"=>"Sanju","reporting_id"=>"1699841000050396825","last_name"=>"Kamble","State"=>"Mumbai"),
array("user_Id"=>"1699841000260209377","email_id"=>"a202412@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202412","first_Name"=>"Dinesh","reporting_id"=>"1699841000050396825","last_name"=>"Dhuri","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000260194274","email_id"=>"a202411@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A202411","first_Name"=>"Ajay","reporting_id"=>"1699841000050396825","last_name"=>"Nakharekar","State"=>"Mumbai"),
array("user_Id"=>"1699841000260174878","email_id"=>"priyanka.waman@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C155640","first_Name"=>"Priyanka","reporting_id"=>"1699841000050396825","last_name"=>"Waman","State"=>"Mumbai"),
array("user_Id"=>"1699841000252657054","email_id"=>"a202390@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202390","first_Name"=>"Bhavesh ","reporting_id"=>"1699841000050396825","last_name"=>"Kotai","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000223629704","email_id"=>"a202236@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202236","first_Name"=>"Poonam","reporting_id"=>"1699841000050396825","last_name"=>"Pokharkar","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000222998705","email_id"=>"a202300@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202300","first_Name"=>"Akshay ","reporting_id"=>"1699841000050396825","last_name"=>"Kamble","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000174664517","email_id"=>"a202091@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202091","first_Name"=>"Rameez","reporting_id"=>"1699841000050396825","last_name"=>"Sayyed","State"=>"Mumbai"),
array("user_Id"=>"1699841000173022942","email_id"=>"a202070@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"a202070","first_Name"=>"Kiran","reporting_id"=>"1699841000050396825","last_name"=>"Patel","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000156370292","email_id"=>"sandeep.dubey@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C152979","first_Name"=>"Sandeep Dubey","reporting_id"=>"1699841000050396825","last_name"=>"","State"=>"Mumbai"),
array("user_Id"=>"1699841000095644973","email_id"=>"a201933@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A201933","first_Name"=>"Sounak","reporting_id"=>"1699841000050396825","last_name"=>"Krutibas Chhatria","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000095393220","email_id"=>"a201939@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"A201939","first_Name"=>"Sneha","reporting_id"=>"1699841000050396825","last_name"=>"Kamble","State"=>"Mumbai"),
array("user_Id"=>"1699841000055577710","email_id"=>"krishna.metregonda@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C149080","first_Name"=>"Krishna","reporting_id"=>"1699841000050396825","last_name"=>"Metregonda","State"=>"Maharashrtra"),
array("user_Id"=>"1699841000055094593","email_id"=>"pratik.worlikar@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C149057","first_Name"=>"Pratik","reporting_id"=>"1699841000050396825","last_name"=>"Worlikar w","State"=>"Mumbai"),
array("user_Id"=>"1699841000055082218","email_id"=>"kunjan.badiyani@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C149045","first_Name"=>"Kunjan","reporting_id"=>"1699841000050396825","last_name"=>"Badiyani","State"=>"Mumbai"),
array("user_Id"=>"1699841000039410868","email_id"=>"moazzam@5paisa.com","role_id"=>"1699841000342631699","Emp_Code"=>"C148024","first_Name"=>"Moazzam","reporting_id"=>"1699841000050396825","last_name"=>"A","State"=>"Mumbai"));
$userd_id_param="user_Id";
$role_id_param="role_id";
$Emp_Code_param="Emp_Code";
$reporting_id_param="reporting_id";
$last_name_param="last_name";
$state_param="state";
foreach ( $movies as $movie ) {
  foreach ( $movie as $key => $value ) {
    error_log ("<dt>$key</dt><dd>$value</dd>");
    if(strpos($key, $userd_id_param)!== false){
      $recordId = $value;
    }
    if(strpos($key, $role_id_param)!== false){
      $role_id = '"'.$value.'"';
    }
    if(strpos($key, $Emp_Code_param)!== false){
      $Emp_Code = '"'.$value.'"';
    }
    if(strpos($key, $state_param)!== false){
      $state = '"'.$value.'"';
    }
    if(strpos($key, $last_name_param)!== false){
      $last_name = '"'.$value.'"';
    }
    if(strpos($key, $reporting_id_param)!== false){
      $reporting_id = '"'.$value.'"';
    }
  }
  $url = "https://www.zohoapis.com/crm/v2/users/$recordId";
  error_log($url);
  $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
  $headers = array("Authorization: $accesstokenparam");
  $content_type = "application/json";
  //$headers->Content-type = $content_type;
  //$headers->Authorization = $accesstokenparam;
  error_log(json_encode($headers));
  $ch = curl_init();
  $param1 = '{"users":[{"Reporting_To":{"id":';
  //$param1 = '{"users":[{"role":';
  //$param10 = ',"role_id":';
  $param9 = ',"reporting_to_id":';
  $reportingid = $reporting_id;
  //$param2 = ', "Emp_Code":';
  //$param3 = ', "state":';
  $param4 = '}}]}'; 
  //$param4 = '}]}'; 
  /*
  {
    "users": [
       {
"role":"${ROLE_ID}"
        }
    ]
}*/
  
  /*
  {
     "users":[
         {
            "Reporting_To":
            {
                "id":"${REPORTING_TO_ID}"
            }
         }
     ]
}*/
  
  $json = $param1.$reportingid.$param4;
  //$json = $param1.$role_id.$param4;
  //$json = $param1.$last_name.$param10.$reportingid.$param2.$Emp_Code.$param3.$state.$param4;
  //$json = $param1.$last_name.$param2.$Emp_Code.$param3.$state.$param4;
  error_log($json);
  $result = json_decode ($json);
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
  curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
  $st=curl_exec($ch);
  error_log("first response");
  error_log($st);
  $Code = "code";
  $Message = "message";
  $AlternatePhoneNumber = "invalid";
  $AlternatePhoneNumber2 = "FAILURE";
  $arr = (json_decode($st, true));
  foreach ( $arr as $key=>$val ){
    if(strpos($key, $Message)!== false){
      if(strpos($val, $AlternatePhoneNumber)!== false){
        $REFRESH_TOKEN_ID = '1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec';
        $CLIENT_ID = '1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U';
        $CLIENT_SECRET = '034bc2464c3093c42b6605b6297af733557ffcc3cb';
        $accesstokenurl = "https://accounts.zoho.com/oauth/v2/token?refresh_token=1000.e6c1444c8dfe5be81e2071d68c92e76b.0442c58394e29dde316f5be4057484ec&client_id=1000.KCRJ9GWGPIJZ56008726DSCMDAUI8U&client_secret=034bc2464c3093c42b6605b6297af733557ffcc3cb&grant_type=refresh_token";
        //$grant_type = 'refresh_token';
        //error_log($accesstokenurl);
        $tokench = curl_init();
        $myObj->grant_type = $grant_type;
        $myObj->refresh_token = $REFRESH_TOKEN_ID;
        $myObj->client_id = $CLIENT_ID;
        $myObj->client_secret=$CLIENT_SECRET;
        $tokenjson = json_encode($myObj);
        curl_setopt($tokench, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($tokench, CURLOPT_URL, $accesstokenurl);
        curl_setopt($tokench, CURLOPT_RETURNTRANSFER, 1);  
        $tokenst=curl_exec($tokench);
        error_log("token response");
        error_log($tokenst);
        $access_token_param="access_token";
        $arr = (json_decode($tokenst, true));
        foreach ( $arr as $key=>$val ){
          if(strpos($key, $access_token_param)!== false){
            error_log($val);
            $access_token=$val;
            //$url = "https://www.zohoapis.com/crm/v2/users/{$recordId}";
            $url = "https://crm.zoho.com/crm/v2/Users";
            error_log($url);
            $accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
            $headers = array("Authorization: $accesstokenparam");
            $content_type = "application/json";
            error_log(json_encode($headers));
            $ch = curl_init();
            $result = json_decode ($json);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "PUT");
            curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
            $st=curl_exec($ch);
            error_log("first response");
            error_log($st);          
          }
        }
      }
    }
  }
}
?>
