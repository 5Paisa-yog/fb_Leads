<?php
$access_token = "1000.c3d50cf57774a5e861ec164b32d9a3be.07bd6c0617df95f5d4b91092aa152c84";
$movies = array(
array("email_id" => "59705771@5paisa.com","last_name" => "SANDIP KUMBHAR","reporting_id" => "1699841000333820388","Emp_Code" => "59705771","state" => "Partner Program"),
array("email_id" => "54549950@5paisa.com","last_name" => "SISIR PATRA","reporting_id" => "1699841000272791604","Emp_Code" => "54549950","state" => "Partner Program"),
array("email_id" => "55541059@5paisa.com","last_name" => "NEETESH KUMAR","reporting_id" => "1699841000272791604","Emp_Code" => "55541059","state" => "Partner Program"),
array("email_id" => "55399983@5paisa.com","last_name" => "SHAILESH .","reporting_id" => "1699841000272791604","Emp_Code" => "55399983","state" => "Partner Program"),
array("email_id" => "55235443@5paisa.com","last_name" => "SWAPNIL DHERE","reporting_id" => "1699841000272791604","Emp_Code" => "55235443","state" => "Partner Program"),
array("email_id" => "54874473@5paisa.com","last_name" => "AMITESH SARKAR","reporting_id" => "1699841000272791604","Emp_Code" => "54874473","state" => "Partner Program"),
array("email_id" => "58192222@5paisa.com","last_name" => "GANESH CHITKOTE","reporting_id" => "1699841000287105075","Emp_Code" => "58192222","state" => "Partner Program"),
array("email_id" => "59445445@5paisa.com","last_name" => "VENKATESWAR KALUVAKOLLU","reporting_id" => "1699841000009989929","Emp_Code" => "59445445","state" => "Partner Program"),
array("email_id" => "58626666@5paisa.com","last_name" => "RAVI MAKWANA","reporting_id" => "1699841000333683707","Emp_Code" => "58626666","state" => "Partner Program"),
array("email_id" => "57304064@5paisa.com","last_name" => "TEJAS SHAH","reporting_id" => "1699841000333842569","Emp_Code" => "57304064","state" => "Partner Program"),
array("email_id" => "57433800@5paisa.com","last_name" => "SANDESH RAI","reporting_id" => "1699841000333842569","Emp_Code" => "57433800","state" => "Partner Program"),
array("email_id" => "50525955@5paisa.com","last_name" => "ARVIND KADAM","reporting_id" => "1699841000333807073","Emp_Code" => "50525955","state" => "Partner Program"),
array("email_id" => "50902955@5paisa.com","last_name" => "DILIP RAKH","reporting_id" => "1699841000333807073","Emp_Code" => "50902955","state" => "Partner Program"),
array("email_id" => "50385053@5paisa.com","last_name" => "ANIL PARADHE","reporting_id" => "1699841000333807073","Emp_Code" => "50385053","state" => "Partner Program"),
array("email_id" => "50840408@5paisa.com","last_name" => "UMESH RUPANAWAR","reporting_id" => "1699841000333807073","Emp_Code" => "50840408","state" => "Partner Program"),
array("email_id" => "50149882@5paisa.com","last_name" => "ANKUR BHUTANI","reporting_id" => "1699841000333807073","Emp_Code" => "50149882","state" => "Partner Program"),
array("email_id" => "51109280@5paisa.com","last_name" => "AMOL SALVE","reporting_id" => "1699841000334602951","Emp_Code" => "51109280","state" => "Partner Program"),
array("email_id" => "51708108@5paisa.com","last_name" => "VIJAYA MULAKALA","reporting_id" => "1699841000334602951","Emp_Code" => "51708108","state" => "Partner Program"),
array("email_id" => "51161860@5paisa.com","last_name" => "TYMGUNDLU RAJESH","reporting_id" => "1699841000334602951","Emp_Code" => "51161860","state" => "Partner Program"),
array("email_id" => "57727575@5paisa.com","last_name" => "HARSHADA BHANGALE","reporting_id" => "1699841000333982380","Emp_Code" => "57727575","state" => "Partner Program"),
array("email_id" => "59893821@5paisa.com","last_name" => "ASHISH SINGH","reporting_id" => "1699841000334764098","Emp_Code" => "59893821","state" => "Partner Program"),
array("email_id" => "59976739@5paisa.com","last_name" => "DEEPAK KAUL","reporting_id" => "1699841000334764098","Emp_Code" => "59976739","state" => "Partner Program"),
array("email_id" => "59322220@5paisa.com","last_name" => "AKHILESH KATARA","reporting_id" => "1699841000334764098","Emp_Code" => "59322220","state" => "Partner Program"),
array("email_id" => "59985808@5paisa.com","last_name" => "MUKESH SHUKLA","reporting_id" => "1699841000334764098","Emp_Code" => "59985808","state" => "Partner Program"),
array("email_id" => "52713334@5paisa.com","last_name" => "AMIT MEHENDALE","reporting_id" => "1699841000333846551","Emp_Code" => "52713334","state" => "Partner Program"),
array("email_id" => "58292887@5paisa.com","last_name" => "MANICKAM SURESH","reporting_id" => "1699841000272351241","Emp_Code" => "58292887","state" => "Partner Program"),
array("email_id" => "59904999@5paisa.com","last_name" => "DINESH VALMIKI","reporting_id" => "1699841000095126800","Emp_Code" => "59904999","state" => "Partner Program"),
array("email_id" => "56871729@5paisa.com","last_name" => "MOHAMMED SOLANKY","reporting_id" => "1699841000333872858","Emp_Code" => "56871729","state" => "Partner Program"),
array("email_id" => "51102129@5paisa.com","last_name" => "NITIN JOSHI","reporting_id" => "1699841000333872858","Emp_Code" => "51102129","state" => "Partner Program"),
array("email_id" => "59978999@5paisa.com","last_name" => "NISHIT DALICHA","reporting_id" => "1699841000272376579","Emp_Code" => "59978999","state" => "Partner Program"),
array("email_id" => "53226262@5paisa.com","last_name" => "KAVITA","reporting_id" => "1699841000331317278","Emp_Code" => "53226262","state" => "Partner Program"),
array("email_id" => "52899991@5paisa.com","last_name" => "JALPABEN PATEL","reporting_id" => "1699841000331317278","Emp_Code" => "52899991","state" => "Partner Program"),
array("email_id" => "56286808@5paisa.com","last_name" => "ANOOP NASA","reporting_id" => "1699841000333832581","Emp_Code" => "56286808","state" => "Partner Program"),
array("email_id" => "54294270@5paisa.com","last_name" => "JAYAVELU VINOTHKUMAR","reporting_id" => "1699841000311564634","Emp_Code" => "54294270","state" => "Partner Program"),
array("email_id" => "54290992@5paisa.com","last_name" => "YOGESH SHIRSAT","reporting_id" => "1699841000311564634","Emp_Code" => "54290992","state" => "Partner Program"),
array("email_id" => "54775776@5paisa.com","last_name" => "BALAJI .","reporting_id" => "1699841000311564634","Emp_Code" => "54775776","state" => "Partner Program"),
array("email_id" => "54809844@5paisa.com","last_name" => "PANKAJ KEDIA","reporting_id" => "1699841000311564634","Emp_Code" => "54809844","state" => "Partner Program"),
array("email_id" => "50409323@5paisa.com","last_name" => "MURARI LAL","reporting_id" => "1699841000331317401","Emp_Code" => "50409323","state" => "Partner Program"),
array("email_id" => "50686888@5paisa.com","last_name" => "NILESHKUMAR NAGAR","reporting_id" => "1699841000311457701","Emp_Code" => "50686888","state" => "Partner Program"),
array("email_id" => "50639667@5paisa.com","last_name" => "LAXMIKANT WANKHEDE","reporting_id" => "1699841000311457701","Emp_Code" => "50639667","state" => "Partner Program"),
array("email_id" => "56111621@5paisa.com","last_name" => "NIDHI RAJPOOT","reporting_id" => "1699841000333846551","Emp_Code" => "56111621","state" => "Partner Program"),
array("email_id" => "55555702@5paisa.com","last_name" => "SANDEEP BADKAR","reporting_id" => "1699841000333842569","Emp_Code" => "55555702","state" => "Partner Program"),
array("email_id" => "56445634@5paisa.com","last_name" => "ABDUL MOQUIM","reporting_id" => "1699841000333807073","Emp_Code" => "56445634","state" => "Partner Program"),
array("email_id" => "54998846@5paisa.com","last_name" => "NARESH YADAV","reporting_id" => "1699841000333807073","Emp_Code" => "54998846","state" => "Partner Program"),
array("email_id" => "58189494@5paisa.com","last_name" => "SANDEEP KUMAR","reporting_id" => "1699841000287018390","Emp_Code" => "58189494","state" => "Partner Program"),
array("email_id" => "54761016@5paisa.com","last_name" => "RAJ MOHAMMED","reporting_id" => "1699841000287018390","Emp_Code" => "54761016","state" => "Partner Program"),
array("email_id" => "52210024@5paisa.com","last_name" => "SANGEET SINGH","reporting_id" => "1699841000311367719","Emp_Code" => "52210024","state" => "Partner Program"));
$email_id_param = "email_id";
$last_name_param = "last_name";
$userd_id_param="user_Id";
$reporting_id_param="reporting_id";
$Emp_Code_param="Emp_Code";
$state_param="state";
foreach ( $movies as $movie ) {
	foreach ( $movie as $key => $value ) {
		error_log ("<dt>$key</dt><dd>$value</dd>");
		if(strpos($key, $userd_id_param)!== false){
			$recordId = $value;
		}
		if(strpos($key, $reporting_id_param)!== false){
			$reporting_id = $value;
		}
		if(strpos($key, $Emp_Code_param)!== false){
			$Emp_Code = '"'.$value.'"';
		}
		if(strpos($key, $state_param)!== false){
			$state = '"'.$value.'"';
		}
		if(strpos($key, $email_id_param)!== false){
			$email_id = '"'.$value.'"';
		}
		if(strpos($key, $last_name_param)!== false){
			$last_name = '"'.$value.'"';
		}
	}
	$zohooneurl = "https://one.zoho.com/api/v1/orgs/655853087/users";
	$zohocrmurl = "https://one.zoho.com/api/v1/orgs/655853087/appaccounts/62042541/members";
	$accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
	$headers = array("Authorization: $accesstokenparam");
	$content_type = "application/json";
  	error_log(json_encode($headers));
  	$ch = curl_init();  
  	$param1 = '{"users" : {"first_name" : "5P Partner","last_name" :';
  	$param2 = ',"emails" : [{"email_id" : ';
  	$param3 = ',}],"generate_password" : true,}}';
  	$json = $param1.$last_name.$param2.$email_id.$param3;
  	error_log($json);
  	$result = json_decode ($json);
  	curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  	curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
  	curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
  	curl_setopt($ch, CURLOPT_URL, $zohooneurl);
  	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
  	$st=curl_exec($ch);
  	error_log("first response");
  	error_log($st);
  	$Code = "code";
  	$Message = "message";
  	$AlternatePhoneNumber = "invalid";
  	$AlternatePhoneNumber2 = "Something went wrong";
	$status_code_param = "status_code";
    $users_param = "users";
	$users_id_param = "zuid";
  	$arr = (json_decode($st, true));
  	foreach ( $arr as $key=>$val ){
		error_log($key);
		if(strpos($key, $Message)!== false){
			if((strpos($val, $AlternatePhoneNumber)!== false)||(strpos($val, $AlternatePhoneNumber2)!== false)){
				$REFRESH_TOKEN_ID = '1000.75d23c87dbfd9bb6ce22e7d6284476fe.8c667a2ecd6233fb5877f015f905f0b0';
				$CLIENT_ID = '1000.EW29NAAKKZMJ44646D0JBLMX8R6EY1';
				$CLIENT_SECRET = 'bb4461932e7a8160b0f8a906b7daba456b6ce3ffbd';
				$accesstokenurl = "https://accounts.zoho.com/oauth/v2/token?refresh_token=1000.75d23c87dbfd9bb6ce22e7d6284476fe.8c667a2ecd6233fb5877f015f905f0b0&client_id=1000.EW29NAAKKZMJ44646D0JBLMX8R6EY1&client_secret=bb4461932e7a8160b0f8a906b7daba456b6ce3ffbd&grant_type=refresh_token";
        		$tokench = curl_init();
        		$myObj->grant_type = $grant_type;
        		$myObj->refresh_token = $REFRESH_TOKEN_ID;
        		$myObj->client_id = $CLIENT_ID;
        		$myObj->client_secret=$CLIENT_SECRET;
        		$tokenjson = json_encode($myObj);
        		curl_setopt($tokench, CURLOPT_CUSTOMREQUEST, "POST");
        		curl_setopt($tokench, CURLOPT_URL, $accesstokenurl);
        		curl_setopt($tokench, CURLOPT_RETURNTRANSFER, 1);  
        		$tokenst=curl_exec($tokench);
        		error_log("token response");
        		error_log($tokenst);
        		$access_token_param="access_token";
        		$arr1 = (json_decode($tokenst, true));
        		foreach ( $arr1 as $key1=>$val1 ){
          			if(strpos($key1, $access_token_param)!== false){
            			error_log($val1);
            			$access_token=$val1;
            			$accesstokenparam = "Zoho-oauthtoken"." ".$access_token;
            			$headers = array("Authorization: $accesstokenparam");
            			$content_type = "application/json";
            			error_log(json_encode($headers));
            			$ch = curl_init();
            			$result = json_decode ($json);
            			curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            			curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
            			curl_setopt($ch, CURLOPT_POSTFIELDS,$json);
            			curl_setopt($ch, CURLOPT_URL, $zohooneurl);
            			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
            			$st=curl_exec($ch);            
            			error_log($st);          
            			$arr2 = (json_decode($st, true));
            			foreach ( $arr2 as $key2=>$val2 ){
							if(strpos($key2, $status_code_param)!== false){
								error_log($val2);
							}
							if(strpos($key2, $users_param)!== false){
								foreach ( $val2 as $key3=>$val3 ){
									if(strpos($key3, $users_id_param)!== false){
										error_log($val3);
										$users_id = $val3;
										$param4 = '{"members" : {"role_id" : "1699841000000026008","profile_id" : "1699841000336610025","zaaid" : "62047589","zuid" :';
										$param5 = '}}';
										$json2 = $param4.$users_id.$param5;
										error_log($json2);
										$result = json_decode ($json);
										curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
										curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
										curl_setopt($ch, CURLOPT_POSTFIELDS,$json2);
										curl_setopt($ch, CURLOPT_URL, $zohocrmurl);
										curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
										$st=curl_exec($ch);
										error_log("first response");
										error_log($st);
									}
								}
							}
						}
      				}
     			}
			}
		}
		if(strpos($key, $status_code_param)!== false){
			error_log($val);
		}
		if(strpos($key, $users_param)!== false){
			foreach ( $val as $key1=>$val1 ){
				error_log($key1);
				if(strpos($key1, $users_id_param)!== false){
					error_log($val1);
					$users_id = $val1;
					error_log($users_id);				
					$param4 = '{"members" : {"role_id" : "1699841000000026008","profile_id" : "1699841000336610025","zaaid" : "62047589","zuid" :';
					$param5 = '}}';
					$json2 = $param4.$users_id.$param5;
					error_log($json2);
					$result = json_decode ($json);
					curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
					curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
					curl_setopt($ch, CURLOPT_POSTFIELDS,$json2);
					curl_setopt($ch, CURLOPT_URL, $zohocrmurl);
					curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  
					$st=curl_exec($ch);
					error_log("first response");
					error_log($st);
				}
			}
		}	
	}
}
?>
